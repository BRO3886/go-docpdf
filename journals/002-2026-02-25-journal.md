# Journal Entry 002 - 2026-02-25 - Docker build, GHCR push, go.mod fix

## Goal

Build and push a production Docker image to GHCR (`ghcr.io/bro3886/go-docpdf`) tagged with both `:latest` and the short git SHA. Also investigated image size vs Gotenberg.

## What Changed

- `Dockerfile`: fixed base image tag — went through `golang:1.24.0-alpine` → `golang:1-alpine` (workaround) → back to `golang:1.24.0-alpine` once Docker Hub recovered
- `go.mod`: lowered minimum Go version from `1.24.5` → `1.24.0` to match the builder image
- Docker image built: `ghcr.io/bro3886/go-docpdf:latest` + `ghcr.io/bro3886/go-docpdf:bb80ed7` (917MB)
- Both tags pushed to GHCR after re-authing with `write:packages` scope
- GitHub repo created: `github.com/BRO3886/go-docpdf` (public), all commits pushed

## Key Insights

**`golang:1.24.0-alpine` vs `go.mod` version conflict:**
`go.mod` had `go 1.24.5` (stamped by local toolchain), but `golang:1.24.0-alpine` only has Go 1.24.0. With `GOTOOLCHAIN=local`, `go mod download` fails immediately:
```
go: go.mod requires go >= 1.24.5 (running go 1.24.0; GOTOOLCHAIN=local)
```
Fix: lower `go.mod` to `go 1.24.0` — no 1.24.5-specific features used. Alternatively could set `GOTOOLCHAIN=auto` in the Dockerfile but lowering go.mod is cleaner.

**Docker Hub throughput issue:**
`registry-1.docker.io` had severe slowness (~800ms TTFB, layer pulls timing out after minutes). `production.cloudflare.docker.com` (used for smaller/more popular images like `alpine`) was fine at 40ms. Root cause: peering issue between ISP and Docker Hub origin, not a Docker Hub outage (status page showed all green). Workaround: switched temporarily to `golang:1-alpine` (served via Cloudflare CDN edge), reverted once Hub recovered.

**OrbStack BuildKit drops connection on slow pulls:**
When layer pulls take too long, OrbStack's BuildKit daemon closes the gRPC stream with `EOF`. The build fails even though the pull is technically still in progress. Workaround: `docker pull` the slow image first to cache it, then `docker build` — BuildKit uses the cache and never needs to hit the registry.

**GHCR `write:packages` scope:**
`gh auth status` showed the token had `repo` but not `write:packages`. Docker login with that token succeeds (GHCR accepts it for auth) but push returns `permission_denied`. Fix: `gh auth refresh -s write:packages` then `docker login ghcr.io -u <user> --password-stdin <<< "$(gh auth token)"`.

**SHA tag mismatch:**
Built image with `rev-parse --short HEAD` at build time, but subsequent commits changed HEAD before the push command ran. The tag `bb80ed7` didn't exist locally because it was computed at a different point. Fix: always `docker tag latest <sha>` just before push rather than passing SHA at build time.

**Image size: 917MB** — entirely LibreOffice (251 Alpine packages). The Go binary is 5MB. For comparison: `gotenberg/gotenberg:8` is 1.86GB (adds Chromium + extras). `linuxserver/libreoffice` is 2.36GB (full desktop GUI). No useful slim LibreOffice base image exists on Docker Hub — `apk add libreoffice` on Alpine is already the minimal approach.

## Decisions Made

- **`go 1.24.0` in go.mod** — matches the pinned builder image, no features above 1.24.0 used, safe to lower
- **Pin builder to `golang:1.24.0-alpine`** (not floating `1-alpine`) — reproducible builds; the temporary `1-alpine` workaround was reverted once Hub recovered
- **Accept 917MB image size** — no viable path to meaningfully smaller without replacing LibreOffice, which would sacrifice PDF fidelity
- **SHA tag computed at push time via `docker tag`** — more reliable than passing SHA as a build arg

---
